Reward API Universal is a service designed to be used in any product which gives users any rewards for any actions

## **Reward Transaction**

Reward Transaction is an entity which tracks and stores user activity start and user activity end. The transaction entity has following structure:

**RowKey**: GUID, unique for each transaction
**PartitionKey**: arena host, e.g. games.clientsite.com
**TimeStamp**: DatTime when the transaction was opened

**ExternalGameId**: game id, e.g. webgl-mahjonng-dimensions
**ExternalUserId**: external user id from the client's login system
**IsCompleted**: indicates the transaction's state, false when transaction is in progress, true when user completes the transaction
**TimeStampOpened**: unix timestamp when the transaction was opened
**TimeStampClosed**: unix timestamp when the transaction was completed
**AvgRevenue**: average revenue for the transaction, insecure, calculated on the client side
**GameplayDuration**: time in seconds how long user was actively engaging the page, insecure, calculated on the client side
**GameScores**: game scores, insecure, calculated on the client side
**PlayHistoryId**: play history id generated by arena-connect, added for back compatibility
**UserIp**: user ip, e.g. 62-183-43-203
 
Transaction opening process is protected by [invisible recaptcha](https://www.google.com/recaptcha/admin#list), access account is arena.arkadium@gmail.com, password is stored at the [teampass](http://teampass.arkadium.com), site key is 6LcXPE8UAAAAAFYXiOlqD2shdbGuyKr7pvsv8cnf

When the captcha validation is passed use the following API call to open the transaction:

```
<script>
    var obj = {
        ExternalUserId: 'test-user', // external user id
        ExternalGameId: 'test-game', // game id
        CaptchaToken: token // token generated by recaptcha
    };

    $.ajax
    ({
        type: "POST",
        beforeSend: function(request) {
            request.setRequestHeader("X-CDN-Target-Host", document.location.hostname); // adding custom header to determine the client
        },
        url: '//arena-uapi-reward.as.arkadiumhosted.com/api/transaction/open',
        contentType: 'application/json',
        async: true,
        data: JSON.stringify(obj),
        success: function (resp) {
            console.log(resp.transactionId);
        }
    });
</script>
```

the API will open the new transaction and return it's Id

When user completes the interactions use the following code to complete the transaction:


```
<script>
    var obj = {
        CaptchaToken: token, // token generated by recaptcha
        TransactionId: transactionId,// transaction id,
        PlayHistoryId: //play history id generated by arena-connect platform, optional field, added for back compatibility
        GameplayDuration: 10, // gameplay duration calculated by custom js
        AvgRevenue: 50, // avg revenue calculated by custom js
        GameScores: 50, // game scores reported by game
        Platform: "pc" // platform pc/tablet/phone
    };

    $.ajax
    ({
        type: "POST",
        beforeSend: function(request) {
            request.setRequestHeader("X-CDN-Target-Host", document.location.hostname); // adding custom header to determine the client
        },
        url: '//arena-uapi-reward.as.arkadiumhosted.com/api/transaction/close',
        contentType: 'application/json',
        async: false,
        data: JSON.stringify(obj)
    });
</script>
```

Sample is located [here](https://arena-uapi-reward.as.arkadiumhosted.com/index.html)

## **Configuration:**

1) Go to Azure Storage Explorer
2) Find arenarewardtransactions storage account
3) Find table ArenaConfig

ArenaConfig table has following columns:

**PartitionKey**: arena host, e.g. games.clientsite.com
**RowKey**: arena host, e.g. games.clientsite.com

**PostbackUrl**: url where to post the transaction, e.g. https://clientsite.com/reward/api
**ExtendedFormat**: post additional data, false by default
**UsePlayHistoryId**: post PlayHistoryId instead of the transaction id, back compatibility for the old clients
**ReportIp**: report user ip address, false by default






